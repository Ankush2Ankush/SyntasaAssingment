# Download data files from S3 before running ETL
files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_download_data.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      
      # Create data directory if it doesn't exist
      mkdir -p /var/app/current/data
      
      # Download data files from S3
      # Replace YOUR_BUCKET_NAME with your actual S3 bucket name
      S3_BUCKET="${S3_DATA_BUCKET:-your-bucket-name}"
      
      if [ -z "$S3_BUCKET" ] || [ "$S3_BUCKET" = "your-bucket-name" ]; then
        echo "Warning: S3_DATA_BUCKET environment variable not set. Skipping data download."
        echo "Please set S3_DATA_BUCKET environment variable in Elastic Beanstalk configuration."
        exit 0
      fi
      
      echo "=========================================="
      echo "Downloading Optimized Database from S3"
      echo "=========================================="
      
      # Download optimized database from S3 (root level)
      echo "Downloading optimized database: s3://$S3_BUCKET/nyc_taxi.db"
      if aws s3 cp s3://$S3_BUCKET/nyc_taxi.db /var/app/current/nyc_taxi.db --no-progress; then
        echo "Database downloaded successfully"
        
        # Set proper permissions
        chown webapp:webapp /var/app/current/nyc_taxi.db
        chmod 664 /var/app/current/nyc_taxi.db
        
        DB_SIZE=$(stat -f%z /var/app/current/nyc_taxi.db 2>/dev/null || stat -c%s /var/app/current/nyc_taxi.db 2>/dev/null || echo "0")
        DB_SIZE_MB=$((DB_SIZE / 1024 / 1024))
        echo "Database size: ${DB_SIZE_MB} MB"
        echo "Database permissions set correctly"
        echo "=========================================="
      else
        echo "ERROR: Failed to download database from S3"
        echo "Will attempt to download data files and run ETL instead..."
        echo ""
        
        # Fallback: Download data files if database download fails
        echo "Downloading data files from s3://$S3_BUCKET/data/..."
        
        # Download parquet files (only if database download failed)
        aws s3 cp s3://$S3_BUCKET/data/yellow_tripdata_2025-01.parquet /var/app/current/data/ --no-progress || echo "Warning: Failed to download yellow_tripdata_2025-01.parquet"
        aws s3 cp s3://$S3_BUCKET/data/yellow_tripdata_2025-02.parquet /var/app/current/data/ --no-progress || echo "Warning: Failed to download yellow_tripdata_2025-02.parquet"
        aws s3 cp s3://$S3_BUCKET/data/yellow_tripdata_2025-03.parquet /var/app/current/data/ --no-progress || echo "Warning: Failed to download yellow_tripdata_2025-03.parquet"
        aws s3 cp s3://$S3_BUCKET/data/yellow_tripdata_2025-04.parquet /var/app/current/data/ --no-progress || echo "Warning: Failed to download yellow_tripdata_2025-04.parquet"
        
        # Download CSV file
        aws s3 cp s3://$S3_BUCKET/data/taxi_zone_lookup.csv /var/app/current/data/ --no-progress || echo "Warning: Failed to download taxi_zone_lookup.csv"
        
        echo "Data files downloaded (ETL will run if database doesn't exist)"
      fi
      
      # Verify database exists
      if [ -f "/var/app/current/nyc_taxi.db" ]; then
        echo ""
        echo "Database file verified:"
        ls -lh /var/app/current/nyc_taxi.db
      fi

option_settings:
  aws:elasticbeanstalk:application:environment:
    # S3 bucket containing data files
    S3_DATA_BUCKET: "nyc-taxi-data-800155829166"

