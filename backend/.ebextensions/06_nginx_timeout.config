# Increase nginx proxy timeouts to 300 seconds (5 minutes)
# Simplified version - uses post-deploy hook instead of container_commands
# This is faster and more reliable

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_set_nginx_timeout.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Set nginx timeouts to 300s for long-running queries
      # This runs after deployment completes
      
      # Backup nginx.conf
      cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
      
      # Add timeout settings if not present
      if ! grep -q "proxy_read_timeout 300s" /etc/nginx/nginx.conf; then
        # Add after http { line
        sed -i '/^http {/a\    proxy_read_timeout 300s;\n    proxy_send_timeout 300s;\n    proxy_connect_timeout 300s;\n    send_timeout 300s;' /etc/nginx/nginx.conf 2>/dev/null || \
        sed -i '/^http{/a\    proxy_read_timeout 300s;\n    proxy_send_timeout 300s;\n    proxy_connect_timeout 300s;\n    send_timeout 300s;' /etc/nginx/nginx.conf 2>/dev/null || true
      fi
      
      # Test and reload nginx
      if nginx -t 2>/dev/null; then
        systemctl reload nginx 2>/dev/null || service nginx reload 2>/dev/null || true
      fi

