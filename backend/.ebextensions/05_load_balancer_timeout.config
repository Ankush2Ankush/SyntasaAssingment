# Increase Application Load Balancer idle timeout to 300 seconds (5 minutes)
# This allows long-running queries to complete without timing out
# Note: Load balancer timeout must be set via AWS CLI script (not available in option_settings)
files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_set_load_balancer_timeout.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Get the load balancer ARN from the environment
      ENV_NAME=$(/opt/aws/bin/cfn-get-metadata -s aws:elasticbeanstalk:environment -k EnvironmentName 2>/dev/null || echo "")
      
      if [ -z "$ENV_NAME" ]; then
        ENV_NAME=$(aws elasticbeanstalk describe-environments --query 'Environments[?CNAME==`'$(hostname -f | cut -d. -f1-3)'`].EnvironmentName' --output text 2>/dev/null || echo "")
      fi
      
      if [ -z "$ENV_NAME" ]; then
        # Try to get from instance tags
        INSTANCE_ID=$(ec2-metadata --instance-id | cut -d " " -f 2)
        ENV_NAME=$(aws ec2 describe-tags --filters "Name=resource-id,Values=$INSTANCE_ID" "Name=key,Values=elasticbeanstalk:environment-name" --query 'Tags[0].Value' --output text 2>/dev/null || echo "")
      fi
      
      if [ ! -z "$ENV_NAME" ]; then
        # Get load balancer ARN
        LB_ARN=$(aws elasticbeanstalk describe-environment-resources --environment-name "$ENV_NAME" --query 'EnvironmentResources.LoadBalancers[0].Name' --output text 2>/dev/null)
        
        if [ ! -z "$LB_ARN" ] && [ "$LB_ARN" != "None" ]; then
          # Get full ARN if we only got the name
          if [[ ! "$LB_ARN" =~ ^arn: ]]; then
            LB_ARN=$(aws elbv2 describe-load-balancers --names "$LB_ARN" --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null)
          fi
          
          if [ ! -z "$LB_ARN" ] && [ "$LB_ARN" != "None" ]; then
            echo "Setting load balancer idle timeout to 300 seconds (5 minutes)..."
            aws elbv2 modify-load-balancer-attributes \
              --load-balancer-arn "$LB_ARN" \
              --attributes Key=idle_timeout.timeout_seconds,Value=300 \
              --region us-east-1 2>&1 | tee -a /var/log/eb-hooks.log
            echo "Load balancer timeout updated successfully"
          else
            echo "Could not find load balancer ARN"
          fi
        else
          echo "No load balancer found (single instance environment?)"
        fi
      else
        echo "Could not determine environment name"
      fi


